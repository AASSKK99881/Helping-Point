<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä»»åŠ¡ - æ ¡å›­äº’åŠ©å¹³å°</title>
    <link rel="stylesheet" href="style.css">
    <style>
/*         body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; }
        .navbar { background-color: white; padding: 0 20px; height: 60px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .back-link { text-decoration: none; color: #666; font-size: 14px; display: flex; align-items: center; }
        .back-link:hover { color: #2196F3; }

        .container { max-width: 800px; margin: 30px auto; padding: 0 15px; }
        
        
        .tabs { display: flex; gap: 20px; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; color: #666; font-weight: bold; position: relative; }
        .tab.active { color: #2196F3; }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: #2196F3; }

        .task-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .task-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .task-title { font-weight: bold; font-size: 16px; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; }
        
       
        .status-PENDING { background: #e3f2fd; color: #2196F3; } 
        .status-ACCEPTED { background: #fff3e0; color: #ff9800; } 
        .status-COMPLETED { background: #e8f5e9; color: #4CAF50; } 

        .btn-complete { background: #ff9800; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-complete:hover { background: #f57c00; }
        
        .empty-tip { text-align: center; color: #999; margin-top: 40px; }
        .btn-abandon { background: #f44336; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-abandon:hover { background: #d32f2f; } */
    </style>
</head>
<body>
    
    <div class="navbar">
        <a href="index.html" class="back-link">â† è¿”å›å¤§å…</a>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('published')">æˆ‘å‘å¸ƒçš„</div>
            <div class="tab" onclick="switchTab('accepted')">æˆ‘æ¥å—çš„</div>
        </div>

        <div id="task-list">
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="config.js"></script>
    <script>
        let allTasks = []; // æš‚å­˜æ‰€æœ‰ä»»åŠ¡
        let currentTab = 'published'; // å½“å‰é€‰ä¸­çš„æ ‡ç­¾
        const currentUserId = parseInt(localStorage.getItem('user_id'));

        window.onload = async function() {
            if (!localStorage.getItem('user_token')) {
                window.location.href = 'login.html';
                return;
            }
            if (!currentUserId) {
                alert("èº«ä»½ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•");
                window.location.href = 'login.html';
                return;
            }
            await fetchAllTasks();
            renderList();
        };

        // 1. è·å–æ‰€æœ‰ä»»åŠ¡ (ç„¶åå‰ç«¯è¿‡æ»¤)
        async function fetchAllTasks() {
            // è¿™é‡Œè°ƒç”¨äº†åç«¯çš„â€œæŸ¥è¯¢æ‰€æœ‰â€æ¥å£ï¼Œè™½ç„¶æ˜¯ç®¡ç†å‘˜ç”¨çš„ï¼Œä½†æ™®é€šç”¨æˆ·å¸¦Tokenä¹Ÿèƒ½è°ƒ
            const res = await request('/tasks'); 
            if (res && res.code === 200) {
                allTasks = res.data;
            }
        }

        // 2. æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            const listDiv = document.getElementById('task-list');
            let filteredList = [];

            if (currentTab === 'published') {
                // ç­›é€‰å‡ºå‘å¸ƒè€…IDç­‰äºæˆ‘çš„IDçš„ä»»åŠ¡
                filteredList = allTasks.filter(t => t.publisherId === currentUserId);
            } else {
                // ç­›é€‰å‡ºæ¥å•è€…IDç­‰äºæˆ‘çš„IDçš„ä»»åŠ¡
                filteredList = allTasks.filter(t => t.accepterId === currentUserId);
            }

            if (filteredList.length === 0) {
                listDiv.innerHTML = '<div class="empty-tip">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ</div>';
                return;
            }

            let html = '';
            // æŒ‰æ—¶é—´å€’åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
            filteredList.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));

            filteredList.forEach(task => {
                let actionBtn = '';
                
                // æƒ…å†µ1: æˆ‘å‘å¸ƒçš„ï¼Œä¸”æ­£åœ¨è¿›è¡Œä¸­ -> æ˜¾ç¤ºâ€œç¡®è®¤å®Œæˆâ€
                if (currentTab === 'published' && task.status === 'ACCEPTED') {
                    actionBtn = `<button class="btn-complete" onclick="confirmComplete(${task.id})">âœ… ç¡®è®¤å®Œæˆ</button>`;
                }
                else if (currentTab === 'published' && task.status === 'PENDING') {
                    // ä½¿ç”¨ class="btn-danger" (çº¢è‰²æŒ‰é’®)
                    actionBtn = `<button class="btn-danger" onclick="deleteTask(${task.id})">ğŸ—‘ï¸ åˆ é™¤</button>`;
                }
                
                // æƒ…å†µ2: æˆ‘æ¥å—çš„ï¼Œä¸”æ­£åœ¨è¿›è¡Œä¸­ -> æ˜¾ç¤ºâ€œæ”¾å¼ƒä»»åŠ¡â€ (æ–°åŠŸèƒ½)
                else if (currentTab === 'accepted' && task.status === 'ACCEPTED') {
                    // è®¡ç®—é¢„è®¡æ‰£åˆ†
                    const penalty = Math.max(1, Math.floor(task.rewardPoints * 0.1));
                    actionBtn = `<button class="btn-abandon" onclick="abandonTask(${task.id}, ${penalty})">ğŸ³ï¸ æ”¾å¼ƒä»»åŠ¡</button>`;
                }

                html += `
                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-title">${task.title} <small style="color:#999">(${task.rewardPoints}åˆ†)</small></span>
                            <span class="status-badge status-${task.status}">${formatStatus(task.status)}</span>
                        </div>
                        <div style="color:#666; font-size:14px; margin-bottom:10px">${task.content}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <span style="font-size:12px; color:#aaa">å‘å¸ƒäº: ${task.createTime.replace('T', ' ')}</span>
                            ${actionBtn}
                        </div>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        // 3. ç¡®è®¤å®ŒæˆåŠŸèƒ½
 // 3. ç¡®è®¤å®ŒæˆåŠŸèƒ½ (ç¾åŒ–ç‰ˆ)
        async function confirmComplete(taskId) {
            // ä½¿ç”¨ Swal.fire æ›¿æ¢ confirm
            const result = await Swal.fire({
                title: 'ç¡®è®¤å·²å®Œæˆï¼Ÿ',
                text: "ç¡®å®šå¯¹æ–¹å·²ç»å®Œæˆäº†ä½ çš„è¯·æ±‚å—ï¼Ÿç¡®è®¤åç§¯åˆ†å°†è½¬ç»™å¯¹æ–¹ã€‚",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4CAF50', // ç»¿è‰²æŒ‰é’®
                cancelButtonColor: '#d33',     // çº¢è‰²æŒ‰é’®
                confirmButtonText: 'æ˜¯çš„ï¼Œç¡®è®¤ç»“ç®—!',
                cancelButtonText: 'å†ç­‰ç­‰'
            });

            // å¦‚æœç”¨æˆ·ç‚¹äº†"å–æ¶ˆ"ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåé¢ä»£ç 
            if (!result.isConfirmed) return;

            const res = await request(`/tasks/${taskId}/complete?userId=${currentUserId}`, 'POST');
            
            if (res && res.code === 200) {
                await Swal.fire('ç»“ç®—æˆåŠŸ!', 'ç§¯åˆ†å·²è½¬ç»™å¯¹æ–¹ã€‚', 'success');
                await fetchAllTasks(); 
                renderList(); 
            } else {
                Swal.fire('æ“ä½œå¤±è´¥', res ? res.msg : "æœªçŸ¥é”™è¯¯", 'error');
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(type) {
            currentTab = type;
            // æ›´æ–°CSSæ ·å¼
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            renderList();
        }

        function formatStatus(status) {
            const map = { 'PENDING': 'å¾…æ¥å•', 'ACCEPTED': 'è¿›è¡Œä¸­', 'COMPLETED': 'å·²å®Œæˆ' };
            return map[status] || status;
        }
        // æ”¾å¼ƒä»»åŠ¡åŠŸèƒ½
// æ”¾å¼ƒä»»åŠ¡åŠŸèƒ½ (ç¾åŒ–ç‰ˆ)
        async function abandonTask(taskId, penalty) {
            const result = await Swal.fire({
                title: 'ç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ',
                html: `âš ï¸ å°†æ‰£é™¤ <b style="color:red">${penalty}</b> ç§¯åˆ†ä½œä¸ºè¿çº¦é‡‘ï¼<br>æ”¾å¼ƒåä»»åŠ¡å°†é‡æ–°å›åˆ°å¤§å…ã€‚`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // çº¢è‰²è­¦å‘Šè‰²
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'å«æ³ªæ”¾å¼ƒ',
                cancelButtonText: 'æˆ‘å†åšæŒä¸€ä¸‹'
            });

            if (!result.isConfirmed) return;

            const res = await request(`/tasks/${taskId}/abandon?userId=${currentUserId}`, 'POST');
            
            if (res && res.code === 200) {
                await Swal.fire('å·²æ”¾å¼ƒ', 'è¿çº¦é‡‘å·²æ‰£é™¤ï¼Œä¸‹æ¬¡åŠ æ²¹ï¼', 'success');
                await fetchAllTasks(); 
                renderList(); 
            } else {
                Swal.fire('æ“ä½œå¤±è´¥', res ? res.msg : "æœªçŸ¥é”™è¯¯", 'error');
            }
        }

        // åˆ é™¤ä»»åŠ¡åŠŸèƒ½
        async function deleteTask(taskId) {
            // SweetAlert2 å¼¹çª—ç¡®è®¤
            const result = await Swal.fire({
                title: 'ç¡®å®šåˆ é™¤ï¼Ÿ',
                text: "åˆ é™¤åï¼Œæ‚¬èµç§¯åˆ†å°†è‡ªåŠ¨é€€è¿˜åˆ°ä½ çš„è´¦æˆ·ã€‚",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'æ˜¯çš„ï¼Œåˆ é™¤ï¼',
                cancelButtonText: 'å–æ¶ˆ'
            });

            if (!result.isConfirmed) return;

            // è°ƒç”¨åç«¯åˆ é™¤æ¥å£
            // æ³¨æ„ä¸­é—´åŠ äº† /published
            const res = await request(`/tasks/published/${taskId}?userId=${currentUserId}`, 'DELETE');
            
            if (res && res.code === 200) {
                await Swal.fire('å·²åˆ é™¤', 'ä»»åŠ¡å·²å–æ¶ˆï¼Œç§¯åˆ†å·²é€€å›ã€‚', 'success');
                await fetchAllTasks(); // åˆ·æ–°æ•°æ®
                renderList(); // åˆ·æ–°ç•Œé¢
            } else {
                Swal.fire('åˆ é™¤å¤±è´¥', res ? res.msg : "æœªçŸ¥é”™è¯¯", 'error');
            }
        }

    </script>
</body>
</html>